{"version":3,"file":"closure.js","mappings":"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","sources":["webpack://uncanny-automator-assets/./src/standalone/closure/index.js"],"sourcesContent":["\"use strict\";\n\n// Check if DOM is already ready\nif (document.readyState === 'loading') {\n\t// DOM is still loading, so add event listener\n\tdocument.addEventListener('DOMContentLoaded', initClosureRedirect);\n} else {\n\t// DOM is already ready, execute immediately\n\tinitClosureRedirect();\n}\n\nfunction initClosureRedirect() {\n\tconst automatorClosureCookie = 'automator_closure_redirect';\n\n\tconst linkId = 'automator-closure-redirect';\n\n\t// Ensure client ID exists for anonymous user tracking\n\tensureClientId();\n\n\t// Create a hidden campaign link\n\tlet link = createLink(linkId);\n\n\t// Wait for the cookie from PHP\n\tconst automatorRedirectTimeout = setInterval(checkCookie, 250);\n\n\t// Debounce timer for redirect checks\n\tlet checkPendingTimeout = null;\n\n\t// Listen for jQuery AJAX completion (most WordPress plugins use jQuery).\n\tif (typeof jQuery !== 'undefined') {\n\t\tjQuery(document).on('ajaxComplete', function() {\n\t\t\tdebouncedCheckForPendingRedirect();\n\t\t});\n\t}\n\n\t// Listen for native fetch and XHR completion (modern forms/apps).\n\t// Uses PerformanceObserver API - non-invasive, no global function overrides.\n\t// This works alongside any other code without conflicts.\n\t// NOTE: Safari/iOS often reports AJAX as \"other\", so jQuery detection above is critical fallback.\n\tif (typeof PerformanceObserver !== 'undefined' && typeof automatorClosure !== 'undefined') {\n\t\ttry {\n\t\t\tconst observer = new PerformanceObserver(function(list) {\n\t\t\t\tconst entries = list.getEntries();\n\t\t\t\tfor (let i = 0; i < entries.length; i++) {\n\t\t\t\t\tconst entry = entries[i];\n\n\t\t\t\t\t// CRITICAL: Ignore our own redirect check requests to prevent infinite loop\n\t\t\t\t\tif (entry.name && entry.name.indexOf('automator_check_closure_redirect') !== -1) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Detect fetch or XHR requests completing\n\t\t\t\t\tif (entry.initiatorType === 'fetch' || entry.initiatorType === 'xmlhttprequest') {\n\t\t\t\t\t\tdebouncedCheckForPendingRedirect();\n\t\t\t\t\t\tbreak; // Only need to trigger once per batch\n\t\t\t\t\t}\n\t\t\t\t\t// Safari/iOS fallback: detect \"other\" requests to AJAX endpoints\n\t\t\t\t\tif (entry.initiatorType === 'other' && entry.name) {\n\t\t\t\t\t\tif (entry.name.indexOf('admin-ajax.php') !== -1 ||\n\t\t\t\t\t\t    entry.name.indexOf('/wp-json/') !== -1 ||\n\t\t\t\t\t\t    entry.name.indexOf('?action=') !== -1) {\n\t\t\t\t\t\t\tdebouncedCheckForPendingRedirect();\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Observe resource and navigation timing entries\n\t\t\tobserver.observe({ entryTypes: ['resource', 'navigation'] });\n\t\t} catch (e) {\n\t\t\t// PerformanceObserver not supported or failed - jQuery + cookie polling will handle it\n\t\t}\n\t}\n\n\t// Debounced redirect check to prevent excessive requests\n\tfunction debouncedCheckForPendingRedirect() {\n\t\tclearTimeout(checkPendingTimeout);\n\t\tcheckPendingTimeout = setTimeout(function() {\n\t\t\tcheckForPendingRedirect();\n\t\t}, 100); // 100ms debounce\n\t}\n\n\tfunction ensureClientId() {\n\t\t// Generate or retrieve client ID for anonymous user tracking\n\t\tlet clientId = localStorage.getItem('automator_client_id');\n\n\t\tif (!clientId || !isValidClientId(clientId)) {\n\t\t\t// Generate a new client ID (32-character hex string)\n\t\t\tclientId = generateClientId();\n\t\t\tlocalStorage.setItem('automator_client_id', clientId);\n\t\t}\n\n\t\t// Store in cookie so PHP can access it during AJAX requests\n\t\t// Cookie expires in 30 days to match localStorage persistence\n\t\tconst date = new Date();\n\t\tdate.setTime(date.getTime() + (30 * 24 * 60 * 60 * 1000));\n\t\tconst expires = 'expires=' + date.toUTCString();\n\t\tdocument.cookie = `automator_client_id=${clientId}; ${expires}; path=/; SameSite=Lax`;\n\t}\n\n\tfunction generateClientId() {\n\t\t// Generate random 32-character hex string\n\t\tconst array = new Uint8Array(16);\n\t\tcrypto.getRandomValues(array);\n\t\treturn Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');\n\t}\n\n\tfunction isValidClientId(id) {\n\t\t// Validate format: 32-character hex string\n\t\treturn /^[a-f0-9]{32}$/.test(id);\n\t}\n\n\tfunction createLink(id) {\n\t\tconst a = document.createElement('a');\n\t\ta.id = id;\n\t\ta.style.display = 'none';\n\t\ta.rel = \"noopener noreferrer\"; // Enhance security for external links\n\t\tdocument.body.appendChild(a);\n\t\treturn a;\n\t}\n\n\tfunction checkCookie() {\n\t\tif (document.hidden) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst redirectURL = getCookie(automatorClosureCookie);\n\t\tif (redirectURL && isValidUrl(redirectURL)) { // Check if the URL is valid\n\t\t\tclearInterval(automatorRedirectTimeout); // Stop polling once redirect is found\n\t\t\tdeleteCookie(automatorClosureCookie);\n\t\t\tlink.href = redirectURL;\n\t\t\tlink.click();\n\t\t}\n\t}\n\n\tfunction isValidUrl(string) {\n\t\t// Directly accept '/' as a valid URL or start with '/' for relative URLs\n\t\tif (string === '/' || string.startsWith('/')) return true;\n\n\t\ttry {\n\t\t\tnew URL(string);\n\t\t\treturn true; // The URL is valid\n\t\t} catch (_) {\n\t\t\treturn false; // The URL is not valid\n\t\t}\n\t}\n\n\tfunction getCookie(cname) {\n\t\tconst name = `${cname}=`;\n\t\tconst decodedCookie = decodeURIComponent(document.cookie);\n\t\tconst ca = decodedCookie.split(';');\n\t\tfor (let i = 0; i < ca.length; i++) {\n\t\t\tlet c = ca[i].trim();\n\t\t\tif (c.indexOf(name) === 0) {\n\t\t\t\treturn c.substring(name.length);\n\t\t\t}\n\t\t}\n\t\treturn \"\";\n\t}\n\n\tfunction deleteCookie(cname) {\n\t\tdocument.cookie = `${cname}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;\n\t}\n\n\tfunction checkForPendingRedirect() {\n\t\t// Check if automatorClosure is available.\n\t\tif (typeof automatorClosure === 'undefined' || !automatorClosure.nonce) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Make AJAX call to check for pending redirect.\n\t\t// SECURITY: Client ID is read from cookie on server-side, NOT passed as parameter.\n\t\t// This prevents abuse where attackers could spam unique client_ids to fill wp_options.\n\t\tconst ajaxUrl = automatorClosure.ajaxUrl || window.ajaxurl || '/wp-admin/admin-ajax.php';\n\n\t\tfetch(ajaxUrl + '?action=automator_check_closure_redirect&nonce=' + automatorClosure.nonce, {\n\t\t\tmethod: 'GET',\n\t\t\tcredentials: 'same-origin'\n\t\t})\n\t\t.then(response => response.json())\n\t\t.then(data => {\n\t\t\tif (data.success && data.data.redirect_url) {\n\t\t\t\t// Set session cookie and let existing polling handle the redirect.\n\t\t\t\tdocument.cookie = `${automatorClosureCookie}=${data.data.redirect_url}; path=/`;\n\t\t\t}\n\t\t})\n\t\t.catch(error => {\n\t\t\t// Silently fail - this is expected if redirect terminates the request\n\t\t\t// or if there's no pending redirect\n\t\t});\n\t}\n}\n"],"names":["initClosureRedirect","automatorClosureCookie","array","clientId","localStorage","getItem","test","Uint8Array","crypto","getRandomValues","Array","from","byte","toString","padStart","join","setItem","date","Date","setTime","getTime","expires","toUTCString","document","cookie","concat","ensureClientId","a","link","createElement","id","style","display","rel","body","appendChild","automatorRedirectTimeout","setInterval","hidden","cname","redirectURL","name","ca","decodeURIComponent","split","i","length","c","trim","indexOf","substring","getCookie","string","startsWith","URL","_","isValidUrl","clearInterval","href","click","checkPendingTimeout","jQuery","on","debouncedCheckForPendingRedirect","PerformanceObserver","automatorClosure","list","entries","getEntries","entry","initiatorType","observe","entryTypes","e","clearTimeout","setTimeout","nonce","ajaxUrl","window","ajaxurl","fetch","method","credentials","then","response","json","data","success","redirect_url","error","checkForPendingRedirect","readyState","addEventListener"],"sourceRoot":""}